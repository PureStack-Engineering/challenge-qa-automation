name: PureStack QA Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit-playwright:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    name: ğŸ•·ï¸ QA Quality Gate

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Phase 1: Structural Integrity (POM Check)
      run: |
        echo "::group::Structure Validation"
        # 1. Check if Pages folder exists and contains strict files
        if [ ! -f "src/pages/LoginPage.ts" ]; then echo "âŒ Missing POM: LoginPage.ts not found in src/pages/"; exit 1; fi
        if [ ! -f "src/pages/InventoryPage.ts" ]; then echo "âŒ Missing POM: InventoryPage.ts not found in src/pages/"; exit 1; fi
        
        # 2. Check if Spec file exists in the right place
        if [ ! -f "src/tests/shop.spec.ts" ]; then echo "âŒ Missing Test: shop.spec.ts not found in src/tests/"; exit 1; fi
        
        echo "âœ… POM Structure & File placement seems valid."
        echo "::endgroup::"

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ•µï¸ Phase 2: Anti-Pattern Detection (Strict)
      run: |
        echo "::group::Static Code Analysis"
        # Ban Hard Waits (Crucial for robust automation)
        if grep -r "waitForTimeout" src/; then
          echo "âŒ CRITICAL: 'page.waitForTimeout' detected. Use explicit waits (toBeVisible) instead."
          exit 1
        fi
        
        # Ban Debugging leftovers
        if grep -r "page.pause()" src/; then
          echo "âŒ CRITICAL: 'page.pause()' detected. Remove debugging code."
          exit 1
        fi
        
        # Ban .only (Don't merge focused tests)
        if grep -r "\.only" src/tests/; then
          echo "âŒ CRITICAL: 'test.only' detected. Do not commit focused tests."
          exit 1
        fi
        
        echo "âœ… Code is clean of major automation anti-patterns."
        echo "::endgroup::"

    - name: ğŸ­ Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: ğŸ§ª Phase 3: Execution (Headless)
      run: npx playwright test

    - name: ğŸ“Š Upload Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
